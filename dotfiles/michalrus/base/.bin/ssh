#!/bin/sh

merge(){
  d="$HOME/.ssh/$1.d"
  f="$HOME/.ssh/$1"

  # do it atomically
  t=$(mktemp -p "$HOME/.ssh")
  cat <<EOF > "$t"
#
# Do not edit this file manually, it will be overwritten, when running ~/.bin/ssh.
# Instead, add your configuration to $d/
#
EOF
  find -L "$d" -not -type d -a -not -name '*.example' -a -not -name '*.pem' | sort | xargs cat >> "$t"
  mv "$t" "$f"
}

merge "authorized_keys"
merge "config"
merge "known_hosts"

case "$TERM" in
  xterm-*)
    export TERM=xterm-256color
    ;;
esac

exec "$(PATH="$(getconf PATH)" command -v ssh)" "$@"
